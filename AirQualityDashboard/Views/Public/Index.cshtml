@model List<AirQualityDashboard.ViewModels.SensorViewModel>

@{
    ViewData["Title"] = "Real-time Air Quality Monitoring - Colombo";
}

<!-- Load Leaflet and Chart.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100vh;
    }

    .legend {
        background: white;
        padding: 10px;
        font-size: 12px;
        line-height: 18px;
        color: #555;
    }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

    .top-right-links {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }

        .top-right-links a {
            margin-left: 10px;
            color: #007bff;
            text-decoration: none;
        }
</style>

<div id="map"></div>

<div id="sensor-list" style="position:absolute; top:60px; left:10px; background:white; padding:10px; z-index:1000; max-height:300px; overflow-y:auto;">
    <h5 style="margin-top:0;">Sensors</h5>
    <ul id="sensor-items" style="list-style:none; padding:0; margin:0;">
    </ul>
</div>

<div id="sensor-chart-container" style="position:absolute; bottom:10px; left:10px; width:350px; height:250px; background:white; padding:10px; z-index:1000; display:none;">
    <canvas id="sensor-chart" style="width:100%; height:200px;"></canvas>
    <div style="margin-top:5px;">
        <button onclick="loadHistoricalData('day')">Day</button>
        <button onclick="loadHistoricalData('week')">Week</button>
        <button onclick="loadHistoricalData('month')">Month</button>
    </div>
</div>


<div class="top-right-links">
    <a href="/Account/Login">Login</a> |
    <a href="/Account/Register">Register</a>
</div>

<script>
       var map = L.map('map').setView([6.9271, 79.8612], 11); // Colombo center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function getColor(aqi) {
        if (aqi <= 50) return "#009966";
        if (aqi <= 100) return "#ffde33";
        if (aqi <= 150) return "#ff9933";
        if (aqi <= 200) return "#cc0033";
        if (aqi <= 300) return "#660099";
        return "#7e0023";
    }

    function getCategory(aqi) {
        if (aqi <= 50) return "😊 Good";
        if (aqi <= 100) return "😐 Moderate";
        if (aqi <= 150) return "😷 Unhealthy (Sensitive)";
        if (aqi <= 200) return "😷 Unhealthy";
        if (aqi <= 300) return "☠️ Very Unhealthy";
        return "☠️ Hazardous";
    }

    // 🔥 Load sensors from backend
    var sensors = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

    // 🌍 Create Leaflet markers safely
    sensors.forEach(sensor => {
        if (sensor.Latitude == null || sensor.Longitude == null) {
            console.warn('Skipping sensor with missing latitude/longitude:', sensor);
            return;
        }

        const aqi = sensor.CurrentAQI ?? Math.floor(Math.random() * 301); // fallback if missing

        var marker = L.marker([sensor.Latitude, sensor.Longitude], {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${getColor(aqi)}; color: #fff; border-radius: 5px; padding: 4px 6px; font-weight:bold;">
                    ${aqi}
                </div>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            })
        }).addTo(map);

        marker.bindPopup(`
            <div id="popup-${sensor.Id}" style="width: 250px;">
                <strong>${sensor.LocationName}</strong><br/>
                <div style="background-color:${getColor(aqi)}; color: black; padding: 5px; margin-top:5px; text-align:center;">
                    ${getCategory(aqi)}<br/>AQI: ${aqi}
                </div>
                <small>Updated just now</small><br/>
                <div style="margin-top:8px;">
                    <select id="range-select-${sensor.Id}" style="width: 100%; padding:4px;">
                        <option value="day">Last Day</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                    </select>
                </div>
                <canvas id="chart-${sensor.Id}" width="250" height="150" style="margin-top:10px;"></canvas>
            </div>
        `);

        marker.on('popupopen', function () {
            loadChart(sensor.Id);
        });
    });

    // 📊 Chart instances storage
    var chartInstances = {};

    function loadChart(sensorId) {
        const rangeSelect = document.getElementById(`range-select-${sensorId}`);
        const canvas = document.getElementById(`chart-${sensorId}`);
        if (!canvas) return;

        function fetchAndRender(range) {
            fetch(`/Home/GetAqiHistory?sensorId=${encodeURIComponent(sensorId)}&days=${range === 'week' ? 7 : range === 'month' ? 30 : 1}`)
                .then(response => response.json())
                .then(data => {
                    if (chartInstances[sensorId]) {
                        chartInstances[sensorId].destroy();
                    }

                    chartInstances[sensorId] = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: `AQI (${range})`,
                                data: data.aqiValues,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 2,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    suggestedMax: 300
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error loading chart:', error));
        }

        fetchAndRender('day');

        if (rangeSelect) {
            rangeSelect.addEventListener('change', () => {
                const selectedRange = rangeSelect.value;
                fetchAndRender(selectedRange);
            });
        }
    }

    // 🖍️ Legend
    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function () {
        var div = L.DomUtil.create('div', 'legend'),
            grades = [0, 50, 100, 150, 200, 300],
            labels = ['Good', 'Moderate', 'Unhealthy (Sensitive)', 'Unhealthy', 'Very Unhealthy', 'Hazardous'];

        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '; width: 18px; height: 18px; display:inline-block; margin-right:8px;"></i> ' +
                labels[i] + '<br>';
        }
        return div;
    };

    legend.addTo(map);

    // 📋 Sidebar sensor list
    var sensorList = document.getElementById('sensor-items');

    sensors.forEach(sensor => {
        var li = document.createElement('li');
        li.innerHTML = `<a href="#" onclick="selectSensor(${sensor.Id}, '${sensor.LocationName}')">${sensor.LocationName}</a>`;
        sensorList.appendChild(li);
    });

    var selectedSensorId = null;
    var historicalChart = null;

    function selectSensor(sensorId, sensorName) {
        selectedSensorId = sensorId;
        document.getElementById('sensor-chart-container').style.display = 'block';
        loadHistoricalData('day');
    }

    function loadHistoricalData(range) {
        if (!selectedSensorId) return;

        let days = range === 'week' ? 7 : range === 'month' ? 30 : 1;

        fetch(`/Home/GetAqiHistory?sensorId=${encodeURIComponent(selectedSensorId)}&days=${days}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('sensor-chart').getContext('2d');

                if (historicalChart) {
                    historicalChart.destroy();
                }

                historicalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: `AQI - Last ${range}`,
                            data: data.aqiValues,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                suggestedMax: 300
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error loading historical AQI data:', error));
    }



</script>

